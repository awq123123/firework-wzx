<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字烟花 - 多点触控+音效+随机图片</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        canvas {
            border: none;
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <canvas id="fireworkCanvas" width="400" height="600"></canvas>

    <script>
        // 核心配置
        const CANVAS_WIDTH = 400;
        const CANVAS_HEIGHT = 600;
        const STAR_COUNT = 100;
        const FONT_SIZE = 30;
        const FONT_HEIGHT = 40;
        const FIREWORK_SPEED = 0.5;
        const PARTICLE_COUNT = 15;
        // 图片显示的固定位置（窗口正上方居中）
        const IMAGE_POS_X = CANVAS_WIDTH / 2 - 50;
        const IMAGE_POS_Y = 0;

        // 获取画布上下文
        const canvas = document.getElementById('fireworkCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;

        // 颜色列表
        const colorList = [
            [255,215,0], [255,140,0], [0,255,255], [127,255,212], [127,255,0],
            [0,250,154], [255,0,0], [255,69,0], [0,110,154], [255,128,128],
            [188,0,255], [255,0,239], [0,255,51]
        ];

        // ====================== 音频资源初始化 ======================
        let riseAudio, explodeAudio;
        
        function preloadAudios() {
            return new Promise((resolve) => {
                let loadedCount = 0;

                // 上升音效（约1s）
                riseAudio = new Audio();
                riseAudio.src = 'rise.mp3'; // 和HTML并列的音频文件
                riseAudio.preload = 'auto';
                riseAudio.volume = 0.7; // 可调整：0=静音，1=最大
                riseAudio.oncanplaythrough = () => {
                    loadedCount++;
                    checkLoaded();
                };

                // 爆炸音效（约0.8s）
                explodeAudio = new Audio();
                explodeAudio.src = 'explode.mp3'; // 和HTML并列的音频文件
                explodeAudio.preload = 'auto';
                explodeAudio.volume = 0.8; // 可调整：0=静音，1=最大
                explodeAudio.oncanplaythrough = () => {
                    loadedCount++;
                    checkLoaded();
                };

                // 容错处理
                function handleAudioError() {
                    loadedCount++;
                    checkLoaded();
                }
                riseAudio.onerror = handleAudioError;
                explodeAudio.onerror = handleAudioError;

                function checkLoaded() {
                    if (loadedCount >= 2) {
                        resolve();
                    }
                }
            });
        }

        // 播放音频工具函数
        function playAudio(audio) {
            if (!audio) return;
            audio.currentTime = 0;
            audio.play().catch(err => {
                console.log('音频播放失败（需先点击页面激活）:', err);
            });
        }

        // ====================== 图片资源初始化 ======================
        const images = [];
        // 图片和HTML并列时直接写文件名
        const imagePaths = [
            'image1.png',
            'image2.png',
            'image3.png'
        ];

        function preloadImages() {
            return new Promise((resolve) => {
                let loadedCount = 0;
                
                imagePaths.forEach((path, index) => {
                    const img = new Image();
                    img.src = path;
                    img.onload = () => {
                        images[index] = img;
                        loadedCount++;
                        if (loadedCount === imagePaths.length) {
                            resolve();
                        }
                    };
                    img.onerror = () => {
                        console.error(`图片加载失败: ${path}`);
                        loadedCount++;
                        if (loadedCount === imagePaths.length) {
                            resolve();
                        }
                    };
                });
            });
        }

        // ====================== 星星系统 ======================
        let stars = [];
        function initStars() {
            stars = [];
            for (let i = 0; i < STAR_COUNT; i++) {
                stars.push({
                    x: Math.random() * CANVAS_WIDTH,
                    y: Math.random() * CANVAS_HEIGHT,
                    size: Math.random() * 2 + 2,
                    brightness: Math.random() * 0.8 + 0.2,
                    speed: Math.random() * 0.01 + 0.01,
                    direction: Math.random() > 0.5 ? 1 : -1
                });
            }
        }

        function updateStars() {
            for (let star of stars) {
                star.brightness += star.speed * star.direction;
                if (star.brightness <= 0.2) {
                    star.brightness = 0.2;
                    star.direction = 1;
                } else if (star.brightness >= 1.0) {
                    star.brightness = 1.0;
                    star.direction = -1;
                }
                const c = Math.floor(255 * star.brightness);
                ctx.fillStyle = `rgb(${c}, ${c}, ${c})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // ====================== 粒子系统 ======================
        class Particle {
            constructor(x, y, vx, vy, life, color) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.life = life;
                this.color = color;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.5;
                this.life--;

                ctx.fillStyle = `rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // ====================== 烟花系统 ======================
        class Firework {
            constructor(targetX, targetY) {
                this.x = targetX;
                this.targetY = targetY;
                this.speed = FIREWORK_SPEED;
                this.color = colorList[Math.floor(Math.random() * colorList.length)];
                this.drops = [CANVAS_HEIGHT / FONT_HEIGHT];
                this.exploded = false;
                this.riseAudioPlayed = false;
            }

            update() {
                if (this.exploded) return;

                // 播放上升音效（仅一次）
                if (!this.riseAudioPlayed) {
                    playAudio(riseAudio);
                    this.riseAudioPlayed = true;
                }

                // 数字拖尾更新
                for (let i = 0; i < this.drops.length; i++) {
                    const text = Math.floor(Math.random() * 10).toString();
                    ctx.font = `${FONT_SIZE}px "Microsoft YaHei", "SimHei", Arial`;
                    ctx.fillStyle = `rgb(${this.color[0]}, ${this.color[1]}, ${this.color[2]})`;
                    const xPos = this.x - 15;
                    const yPos = this.drops[i] * FONT_HEIGHT;
                    ctx.fillText(text, xPos, yPos);
                    this.drops[i] -= this.speed;

                    // 触发爆炸
                    if (this.drops[i] * FONT_HEIGHT <= this.targetY && !this.exploded) {
                        this.exploded = true;
                        this.createParticles(xPos + 10, yPos);
                    }
                }
            }

            createParticles(x, y) {
                // 播放爆炸音效
                playAudio(explodeAudio);

                // 1/10概率显示图片（窗口正上方居中）
                const rand = Math.floor(Math.random() * 10) + 1;
                if (rand === 1) {
                    const imgIndex = Math.floor(Math.random() * 3);
                    if (images[imgIndex]) {
                        ctx.drawImage(images[imgIndex], IMAGE_POS_X, IMAGE_POS_Y);
                    }
                }

                // 生成粒子
                for (let i = 0; i < PARTICLE_COUNT; i++) {
                    const vx = Math.floor(Math.random() * 17) - 8;
                    const vy = Math.floor(Math.random() * 11) - 15;
                    const life = Math.floor(Math.random() * 21) + 10;
                    particles.push(new Particle(x, y, vx, vy, life, this.color));
                }
            }
        }

        // ====================== 全局变量 & 多点触控交互 ======================
        let fireworks = [];
        let particles = [];

        // 统一生成烟花的函数
        function createFireworkAtPosition(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const clickX = (clientX - rect.left) * (CANVAS_WIDTH / rect.width);
            const clickY = (clientY - rect.top) * (CANVAS_HEIGHT / rect.height);
            fireworks.push(new Firework(clickX, clickY));
        }

        // 1. 鼠标点击（兼容电脑）
        canvas.addEventListener('click', (e) => {
            createFireworkAtPosition(e.clientX, e.clientY);
        });

        // 2. 触屏多点触控（支持多手指同时点击）
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // 阻止默认触屏行为（缩放/滚动）
            // 循环处理所有同时按下的手指触点
            for (let i = 0; i < e.touches.length; i++) {
                const touch = e.touches[i];
                createFireworkAtPosition(touch.clientX, touch.clientY);
            }
        }, { passive: false });

        // ====================== 主循环 ======================
        function mainLoop() {
            requestAnimationFrame(mainLoop);

            // 半透明遮罩保留拖尾
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // 更新星星
            updateStars();

            // 更新烟花
            const activeFireworks = [];
            for (let fw of fireworks) {
                fw.update();
                if (!fw.exploded) {
                    activeFireworks.push(fw);
                }
            }
            fireworks = activeFireworks;

            // 更新粒子
            const activeParticles = [];
            for (let p of particles) {
                p.update();
                if (p.life > 0) {
                    activeParticles.push(p);
                }
            }
            particles = activeParticles;
        }

        // ====================== 初始化 ======================
        initStars();
        // 并行加载音频和图片后启动
        Promise.all([preloadAudios(), preloadImages()]).then(() => {
            mainLoop();
            window.dispatchEvent(new Event('resize'));
        });

        // 窗口适配
        window.addEventListener('resize', () => {
            const scale = Math.min(
                window.innerWidth / CANVAS_WIDTH,
                window.innerHeight / CANVAS_HEIGHT
            );
            canvas.style.transform = `scale(${scale})`;
        });
    </script>
</body>
</html>
